## LOAD DATA AND PACKAGES #############################################################

library(R2jags)
library(mvtnorm)
library(data.table)
# library(shinystan)

source("00.common.R")
source("load.try.data.R")
source("custom.jags.R")

if(!dir.exists("output")) dir.create("output")

args = commandArgs(trailingOnly=TRUE)
if(length(args) == 0){
  args = c("uni=FALSE", "uni.group=TRUE", 
           "multi=FALSE", "multi.group=TRUE", 
           "hier=TRUE", "with.na=TRUE", 
           "n.chains=3") # just for testing
}
print(args)

for(i in 1:length(args)){
  eval(parse(text=args[i]))
}

global.trait.means <- as.numeric(try.na[, lapply(.SD, mean, na.rm=TRUE),
                                 .SDcols = traits])
names(global.trait.means) <- traits

na <- ifelse(with.na, ".na","") 
DT.run <- get(paste0("try", na))[,pft:=droplevels(pft)][, pft := as.numeric(pft)]
pfts <- unique(DT.run[,pft])

## UNIVARIATE ##################################################################

if(uni){
  print("Start univariate model without grouping")
  dir <- sprintf("output/uni.trait%s",na)
  if(!dir.exists(dir)) dir.create(dir)
  DT <- DT.run
  source("models/run.uni.R")
  save(out, file = sprintf("%s/uni.trait%s.Rdata",dir, na))
  remove(model,out)
  remove(DT)
  print("Done!")
}

if(uni.group){
  print("Start univariate model with grouping") 
  dir <- sprintf("output/uni.trait%s",na)
  if(!dir.exists(dir)) dir.create(dir)
  errors <- numeric(0)
  for(i in 1:length(pfts)){
    print(paste("Running PFT", pfts[i]))
    DT <- DT.run[pft == pfts[i]]
    source("models/run.uni.R")
    if (!all(is.error(out))){
        save(out, file = sprintf("%s/uni.trait%s.pft.%02.0f.Rdata",dir, na, i))
    } else {
        warning(sprintf("Error running PFT %d. Skipping and moving on", pfts[i]))
    }
    remove(DT)
    print(paste("Done!", pfts[i]))
    if(length(errors) != 0){
        warning(paste("Errors in the following models:", errors, collapse=" "))
    }
  }
  print("All Done!")
}

## MULTIVARIATE ################################################################

if(multi){
  print("Start multivariate model without grouping")
  dir <- sprintf("output/multi.trait%s",na)
  if(!dir.exists(dir)) dir.create(dir)
  DT <- DT.run
  source("models/run.multi.R")
  save(out, file = sprintf("%s/multi.trait%s.Rdata",dir, na, i))
  remove(model,out)
  remove(DT)
  print("Done!")
}

if(multi.group){
  print("Start multivariate model with grouping")
  dir <- sprintf("output/multi.trait%s",na)
  if(!dir.exists(dir)) dir.create(dir)
  for(i in 1:length(pfts)){
    DT <- DT.run[pft == pfts[i]]
    source("models/run.multi.R")
    save(out, file = sprintf("%s/multi.trait%s.pft.%02.0f.Rdata",dir, na, i))
    remove(DT)
    print(paste("Done!", pfts[i]))
  }
  print("All Done!")
}

## HIERARCHICAL ################################################################

if(hier){
  print("Start hierarchical model")
  dir <- sprintf("output/hier.trait.pft%s",na)
  if(!dir.exists(dir)) dir.create(dir)
  DT <- DT.run
  source("models/run.hier.R")
  save(out, file = sprintf("%s/hier.trait.pft%s.Rdata",dir,na))
  remove(model,out)
  remove(DT)
  print("Done!")
}

## PRINT WARNINGS ##############################################################

print("=================================")
print("PRINT WARNINGS")

warnings()
